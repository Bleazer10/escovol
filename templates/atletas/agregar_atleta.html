{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="col-md-6">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item">
        <a class="link-body-emphasis" href="{% url 'menu_principal' %}">
          <i class="fa-solid fa-house"></i>
        </a>
      </li>
      <li class="breadcrumb-item">
        <a class="link-body-emphasis" href="{% url 'lista_atletas' %}">Atletas</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">Agregar</li>
    </ol>
  </nav>
</div>

<div class="container mt-5">
  {% if is_admin %}
  <form method="post">
    {% csrf_token %}

    <!-- Card de Usuario -->
    <div class="card mb-5 border border-primary shadow-sm">
      <div class="card-header bg-primary text-white fw-semibold text-center fs-5">
        üîë Datos de Usuario
      </div>
      <div class="card-body row g-3">
        <div class="col-md-6">
          <label for="{{ usuario_form.username.id_for_label }}" class="form-label fw-semibold">Usuario</label>
          {{ usuario_form.username|add_class:"form-control" }}
          {% for error in usuario_form.username.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-6">
          <label for="{{ usuario_form.email.id_for_label }}" class="form-label fw-semibold">Correo</label>
          {{ usuario_form.email|add_class:"form-control" }}
          {% for error in usuario_form.email.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-6">
          <label for="{{ usuario_form.password.id_for_label }}" class="form-label fw-semibold">Contrase√±a</label>
          {{ usuario_form.password|add_class:"form-control" }}
          {% for error in usuario_form.password.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="col-md-6">
            <label for="{{ usuario_form.is_active.id_for_label }}" class="form-label fw-semibold">Estado</label>
            {{ usuario_form.is_active|add_class:"form-control" }}
            {% for error in usuario_form.is_active.errors %}
                <div class="text-danger small">{{ error }}</div>
            {% endfor %}
        </div>
      </div>
    </div>

    <!-- Card de Atleta -->
    <div class="card shadow border border-primary ">
      <div class="card-header">
        <h4 class="text-center mb-0">üèêü§æüèª Datos de Atleta</h4>
      </div>
      <div class="card-body p-5">
        <div class="row g-3">
          {% for field in form %}
            {% if field.name != 'peso' and field.name != 'estatura' and field.name != 'salto' and field.name != 'alcance' and field.name != 'direccion' and field.name != 'representante_nombre' and field.name != 'representante_apellido' and field.name != 'representante_cedula' and field.name != 'representante_telefono' %}
              <div class="col-md-6">
                <label for="{{ field.id_for_label }}" class="form-label fw-semibold text-dark">{{ field.label }}</label>
                {{ field|add_class:"form-control" }}
                {% if field.help_text %}
                  <div class="form-text text-muted">{{ field.help_text }}</div>
                {% endif %}
                {% for error in field.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>

              {% if field.name == 'turno' %}
                <!-- Direcci√≥n justo al lado de Turno -->
                <div class="col-md-6">
                  <label for="{{ form.direccion.id_for_label }}" class="form-label fw-semibold text-dark">Direcci√≥n</label>
                  {{ form.direccion|add_class:"form-control" }}
                  {% for error in form.direccion.errors %}
                    <div class="text-danger small">{{ error }}</div>
                  {% endfor %}
                </div>
              {% endif %}

            {% endif %}
          {% endfor %}
        </div>

        <!-- Card Antropom√©trica -->
        <div class="card mt-5 border border-secondary shadow-sm">
          <div class="card-header bg-secondary text-white fw-semibold fs-5 text-center">
            üßç‚Äç‚ôÇÔ∏è DATOS ANTROPOM√âTRICOS
          </div>
          <div class="card-body row g-3 px-3">
            {% for field in form %}
              {% if field.name in 'peso estatura salto alcance' %}
                <div class="col-md-6">
                  <label for="{{ field.id_for_label }}" class="form-label fw-semibold text-dark">{{ field.label }}</label>
                  {{ field|add_class:"form-control" }}
                  {% for error in field.errors %}
                    <div class="text-danger small">{{ error }}</div>
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <!-- Card Representante -->
        <div class="card mt-5 border border-secondary shadow-sm rounded-4 d-none" id="card-representante">
          <div class="card-header bg-secondary text-white fw-semibold fs-5 text-center rounded-top-4">
            üë§ DATOS DEL REPRESENTANTE
          </div>
          <div class="card-body row g-3 px-3">
            {% for field in form %}
              {% if field.name == 'representante_nombre' or field.name == 'representante_apellido' or field.name == 'representante_cedula' or field.name == 'representante_telefono' %}
                <div class="col-md-6">
                  <label for="{{ field.id_for_label }}" class="form-label fw-semibold text-dark">{{ field.label }}</label>
                  {{ field|add_class:"form-control" }}
                  {% for error in field.errors %}
                    <div class="text-danger small">{{ error }}</div>
                  {% endfor %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <!-- Botones -->
        <div class="mt-4 d-flex justify-content-center gap-3">
          <button type="submit" class="btn" style="background: #4caf50;">
            <i class="fa-solid fa-floppy-disk"></i> Guardar
          </button>
          <a href="{% url 'lista_atletas' %}" class="btn" style="background: #f8b100;">
            <i class="fa-solid fa-arrow-left"></i> Cancelar
          </a>
        </div>
      </div>
    </div>
  </form>
  {% else %}
  <div class="alert alert-danger text-center mt-5">
    No tienes permiso para acceder a esta secci√≥n.
  </div>
  {% endif %}
</div>

<!-- Script para mostrar card representante si menor de 18 -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const nacimientoInput = document.getElementById("id_fecha_nacimiento");
    const cardRepresentante = document.getElementById("card-representante");

    function calcularEdad(fechaNacStr) {
      const hoy = new Date();
      const fechaNac = new Date(fechaNacStr);
      let edad = hoy.getFullYear() - fechaNac.getFullYear();
      const m = hoy.getMonth() - fechaNac.getMonth();
      if (m < 0 || (m === 0 && hoy.getDate() < fechaNac.getDate())) {
        edad--;
      }
      return edad;
    }

    function verificarEdad() {
      const valor = nacimientoInput.value;
      if (valor) {
        const edad = calcularEdad(valor);
        if (edad < 18) {
          cardRepresentante.classList.remove("d-none");
        } else {
          cardRepresentante.classList.add("d-none");
        }
      }
    }

    nacimientoInput.addEventListener("change", verificarEdad);
    verificarEdad();
  });
</script>

{% endblock %}
