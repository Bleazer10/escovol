{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-3">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a class="link-body-emphasis" href="{% url 'menu_principal' %}">
          <i class="fa-solid fa-house"></i>
          <span class="visually-hidden">Inicio</span>
        </a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        Administración
      </li>
    </ol>
  </nav>

  <div class="card shadow border border-primary">
    <div class="card-header text-white text-center fw-bold fs-3">
      Administración de Mensualidades
    </div>

    <div class="card-body p-4">
      <!-- Formulario de Filtros -->
      <form method="get" class="row gx-2 gy-3 align-items-end mb-4">

        <!-- Mes -->
        <div class="col-lg-3 col-md-3 col-6">
          <label for="mes" class="form-label fw-semibold">Mes</label>
          <select name="mes" id="mes" class="form-select shadow-sm py-2">
            {% for num, nombre in meses %}
              <option value="{{ num }}" {% if mes_filtro == num %}selected{% elif not mes_filtro and num == mes_actual %}selected{% endif %}>{{ nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Año -->
        <div class="col-lg-2 col-md-3 col-6">
          <label for="año" class="form-label fw-semibold">Año</label>
          <input type="number" name="año" id="año" value="{{ año_actual }}" class="form-control shadow-sm py-2">
        </div>

        <!-- Categoría -->
        <div class="col-lg-3 col-md-4 col-6">
          <label for="categoria" class="form-label fw-semibold">Categoría</label>
          <select name="categoria" id="categoria" class="form-select shadow-sm py-2">
            <option value="">Todas</option>
            {% for cat in categorias %}
              <option value="{{ cat }}" {% if categoria_filtro == cat %}selected{% endif %}>{{ cat }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Botón Filtrar -->
        <div class="col-lg-2 col-md-3 col-6">
          <button type="submit" class="btn btn-sm btn-outline-dark w-100 shadow ">
            <i class="fas fa-search"></i> Filtrar
          </button>
        </div>

        <!-- Botón Limpiar -->
        <div class="col-lg-2 col-md-3 col-6">
          <a href="{% url 'administracion' %}" class="btn btn-sm btn-secondary w-100 shadow"> <i class="fas fa-trash-alt"></i>
            Limpiar
          </a>
        </div>
      </form>

      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-center shadow-sm border-success">
            <div class="card-body">
              <h6 class="text-muted">Recaudado del Mes</h6>
              <h3 class="text-success fw-bold">${{ total_recaudado|floatformat:2 }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center shadow-sm border-primary">
            <div class="card-body">
              <h6 class="text-muted">Al Día</h6>
              <h3 class="fw-bold text-primary">{{ al_dia }}/{{ total_atletas }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center shadow-sm border-warning">
            <div class="card-body">
              <h6 class="text-muted">Exonerados</h6>
              <h3 class="fw-bold text-warning">{{ exonerados }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center shadow-sm border-danger">
            <div class="card-body">
              <h6 class="text-muted">Con Deuda</h6>
              <h3 class="fw-bold text-danger">{{ deudores }}</h3>
            </div>
          </div>
        </div>
      </div>


      <!-- Tabla de Atletas -->
      <div class="table-responsive p-4">
        <table class="table table-hover table-bordered align-middle text-center">
          <thead class="table-dark">
            <tr>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>Categoría</th>
              <th>Estado</th>
              <th>Monto</th>
              <th>Exonerado</th>
              <th>Guardar</th>
            </tr>
          </thead>
          <tbody>
            {% for item in page_obj %}
              <tr>
                <td>{{ item.atleta.nombre }}</td>
                <td>{{ item.atleta.apellido }}</td>
                <td class="text-center align-middle" style="width: 130px;">{{ item.atleta.categoria }}</td>
                <td class="text-center align-middle" style="width: 130px;">
                  {% if item.mensualidad %}
                    <span class="badge 
                      {% if item.mensualidad.estado == 'al_dia' %} bg-success 
                      {% elif item.mensualidad.estado == 'deuda' %} bg-danger 
                      {% else %} bg-secondary {% endif %}">
                      {{ item.mensualidad.estado|capfirst }}
                    </span>
                  {% else %}
                    <span class="badge bg-secondary">Sin registro</span>
                  {% endif %}
                </td>
                {% if item.mensualidad %}
                  <form method="POST" action="{% url 'actualizar_mensualidad' item.mensualidad.id %}">
                    {% csrf_token %}
                    <td class="text-center align-middle" style="width: 150px;">
                      <input type="number" step="0.01" name="monto"
                            class="form-control form-control-sm text-center mx-auto"
                            style="width: 100px;"
                            value="{{ item.mensualidad.monto_pagado }}">
                    </td>
                    <td class="text-center align-middle" style="width: 120px;">
                      <input type="checkbox" name="exonerado" class="form-check-input"
                            {% if item.mensualidad.exonerado %}checked{% endif %}>
                    </td>
                    <td>
                      <button type="submit" class="btn btn-sm" style="background: #4caf50;">
                        <i class="fa-solid fa-floppy-disk"></i>
                      </button>
                    </td>
                  </form>
                {% else %}
                  <td colspan="3" class="text-center text-muted">Sin mensualidad registrada</td>
                {% endif %}
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center text-muted">No hay datos para mostrar.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Paginación SIEMPRE visible -->
      <div class="d-flex justify-content-center mt-4">
        <nav>
          <ul class="pagination pagination-sm">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link px-3 py-1" href="?page={{ page_obj.previous_page_number }}{% if mes_filtro %}&mes={{ mes_filtro }}{% endif %}{% if año_actual %}&año={{ año_actual }}{% endif %}{% if categoria_filtro %}&categoria={{ categoria_filtro }}{% endif %}">← Anterior</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link px-3 py-1">← Anterior</span>
              </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <li class="page-item active">
                  <span class="page-link px-3 py-1">{{ num }}</span>
                </li>
              {% else %}
                <li class="page-item">
                  <a class="page-link px-3 py-1" href="?page={{ num }}{% if mes_filtro %}&mes={{ mes_filtro }}{% endif %}{% if año_actual %}&año={{ año_actual }}{% endif %}{% if categoria_filtro %}&categoria={{ categoria_filtro }}{% endif %}">{{ num }}</a>
                </li>
              {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link px-3 py-1" href="?page={{ page_obj.next_page_number }}{% if mes_filtro %}&mes={{ mes_filtro }}{% endif %}{% if año_actual %}&año={{ año_actual }}{% endif %}{% if categoria_filtro %}&categoria={{ categoria_filtro }}{% endif %}">Siguiente →</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link px-3 py-1">Siguiente →</span>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>

    </div>
  </div>
</div>
{% endblock %}
